tinymce.PluginManager.add('ewimage', function (editor, url) {
   // Add a button that opens a window


   editor.addButton('ewimage', {
      text: "EW Media",
      tooltip: 'EW Media Manager',
      icon: "image",
      onclick: function () {
         if (!editor.settings.ew_media_url)
         {
            alert("Please specify ew_media_url");
            return;
         }
         // Open window
         var dp = EW.createModal({onClose: function ()
            {
               //EW.removeURLHandler(media.handler, "Media");
               //EW.removeURLHandler(EWhandler, "Media");
            }});
         $.post(editor.settings.ew_media_url, function (data) {
            dp.append("<div class='footer-pane row actions-bar action-bar-items' ></div>");
            // create button to add photo to the editor
            var bSelectPhoto = EW.addAction("Select Photo", function () {
               EW.setHashParameter("select-photo", true, "Media");
            }, {display: "none"}).addClass("btn-success");
            // create handler to track selected
            var EWhandler = function ()
            {
               var url = EW.getHashParameter("absUrl", "Media");
               if (url)
                  bSelectPhoto.comeIn(300);
               else
                  bSelectPhoto.comeOut(200);
               if (EW.getHashParameter("select-photo", "Media"))
               {
                  EW.setHashParameter("select-photo", null, "Media");
                  dp.dispose();
                  //if (EW.getHashParameter("url", "Media"))
                  editor.insertContent("<img src='" + EW.getHashParameter("absUrl", "Media") + "' alt=''>");
               }
            };
            EW.addURLHandler(EWhandler, "Media");
            // add the media section content to the dialog
            // after the footer-pane because the buttons should be added to the dooter-pane instead of main actions bar
            var d = $("<div class='form-content'></div>").append(data);
            dp.prepend(d);
            // add header at begining
            dp.prepend("<h1>EW Media</h1>");
         });
      }
   });
   /*editor.addMenuItem('example', {
      text: 'EW Media',
      context: 'tools',
      onclick: function () {
         // Open window with a specific url
         editor.windowManager.open({
            title: 'TinyMCE site',
            url: 'http://www.tinymce.com',
            width: 800,
            height: 600,
            buttons: [{
                  text: 'Close',
                  onclick: 'close'
               }]
         });
      }
   });*/

});