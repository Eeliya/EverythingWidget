<?phpsession_start();include($_SESSION['ROOT_DIR'] . '/config.php');include_once 'WidgetsManagementCore.php';$uiStructureId = mysql_real_escape_string($_POST['uiStructureId']);$partId = mysql_real_escape_string($_POST['partId']);$widgetId = mysql_real_escape_string($_POST['widgetId']);$parentId = mysql_real_escape_string($_POST['parentId']);$panelId = mysql_real_escape_string($_POST['panelId']);$position = mysql_real_escape_string($_POST['position']);$order = mysql_real_escape_string($_POST['order']);if (!$order){  $order = 0;}if ($_REQUEST['cmd'] == 'Add' && $uiStructureId){  if ($widgetId && $parentId)  {    $result = mysql_query("INSERT INTO ui_structures_parts (ui_structure_id             , item_type , item_id , container_id , ui_structures_parts.order)             VALUES ('$uiStructureId' , 'widget' , '$widgetId' , '$parentId' , '$order')");  }  if ($panelId)  {    $result = mysql_query("INSERT INTO ui_structures_parts (ui_structure_id             , item_type , item_id , container_id , ui_structures_parts.order)             VALUES ('$uiStructureId' , 'panel' , '$panelId' , '0' , '$position:$order')");  }  if ($result)  {    ?>    <span class="Title" style="color: #339900;" >      جز جدید با موفقیت اضافه شد    </span>    <script  type="text/javascript">      listParts();    </script>    <?php    return;  }  else  {    ?>    <span class="Title" style="color: #dd2200;" >      خطا: جز جدید اضافه نشد    </span>    <?php    return;  }  return;}if ($_REQUEST['cmd'] == 'Edit' && $partId){  if ($widgetId && $parentId)  {    $result = mysql_query("UPDATE ui_structures_parts                 SET item_type = 'widget'                , item_id = '$widgetId'                , container_id = '$parentId'                , ui_structures_parts.order = '$order'                WHERE id = '$partId'") or die(mysql_error());  }  if ($panelId)  {    $result = mysql_query("UPDATE ui_structures_parts                 SET item_type = 'panel'                , item_id = '$panelId'                , ui_structures_parts.order = '$position:$order'                WHERE id = '$partId'") or die(mysql_error());  }  if ($result)  {    ?>    <script  type="text/javascript">      listParts();    </script>    <?php    return;  }  else  {    echo 'error';    return;  }  return;}if ($_REQUEST['cmd'] == 'See' && $widgetId){  $result = mysql_query("SELECT * FROM ui_structures_parts WHERE id = '$widgetId'") or die(mysql_error());  while ($row = mysql_fetch_array($result))  {    /*$type = $row['item_type'];    if ($row['item_type'] == 'widget')    {      $widgetId = $row['item_id'];    }    if ($row['item_type'] == 'panel')    {      $panelId = $row['item_id'];    }    $parentId = $row['container_id'];    $order = $row['order'];    $class = $row['class'];    $temp = split(":", $order);    if (!$temp[1])      $temp[1] = $temp[0];*/  }}if ($_REQUEST['cmd'] == 'AddWidget'){  $result = mysql_query("SELECT * FROM ui_structures_parts WHERE ui_structure_id = '$uiStructureId' AND item_id = '$panelId'") or die(mysql_error());  while ($row = mysql_fetch_array($result))  {    $type = 'panel';  }}if ($_REQUEST['cmd'] == 'Delete' && $widgetId){  $result = mysql_query("DELETE FROM ui_structures_parts WHERE item_id = '$widgetId' AND ui_structure_id = '$uiStructureId'");  if ($result)  {    ?>    <script  type="text/javascript">      listParts();    </script>    <?php  }  return;}?><h1>  Add Widget</h1><div id="PartForm" class="form-content">  <div class="row">    <label>      Type    </label>    <div class="ComboBox" style="width: 100px;margin-right: 10px;">      <select id="type" onchange="changeType()">        <option value="1" <?php echo $type == 'panel' ? 'selected' : '' ?>>          Panels        </option>        <option value="2" <?php echo $type == 'widget' ? 'selected' : '' ?>>          Widget        </option>      </select>    </div>    <div id="widgets" class="ComboBox" style="width: 250px;">      <select id="widgetId" >        <?php        $result = getWidgets();        while ($row = mysql_fetch_array($result))        {          ?>		          <option value="<?php echo $row['id']; ?>" <?php echo $row['id'] == $widgetId ? 'selected' : '' ?>>            <?php echo $row['title']; ?>                      </option>          <?php        }        ?>      </select>    </div>  </div>  <div id="parents" class="row">    <label>      Attach to panel    </label>    <div  class="ComboBox" style="width: 250px;">      <select id="parentId" >        <?php        $result = getPanelsOfStructure($uiStructureId);        while ($row = mysql_fetch_array($result))        {          ?>		          <option value="<?php echo $row['id']; ?>" <?php echo $row['id'] == $parentId ? 'selected' : '' ?>>            <?php echo $row['name']; ?>                      </option>          <?php        }        ?>      </select>    </div>  </div>  <div id="panels" class="row">    <div class="ComboBox" style="width: 250px;">      <select id="panelId" >        <?php        if ($type == 'panel' || $type == 'widget')        {          $result = mysql_query("SELECT *                     FROM panels");        }        else        {          $result = mysql_query("SELECT *                     FROM panels WHERE id not in (SELECT item_id FROM ui_structures_parts WHERE item_type = 'panel' AND ui_structure_id = '$uiStructureId')");        }        while ($row = mysql_fetch_array($result))        {          ?>		          <option value="<?php echo $row['id']; ?>" <?php echo $row['id'] == $panelId ? 'selected' : '' ?>>            <?php echo $row['name']; ?>                      </option>          <?php        }        ?>      </select>    </div>  </div>  <div class="row">    <label>      Order    </label>    <input class="text-field" id="order" style="width: 50px; direction: ltr; text-align: center;" onkeypress="validate(event, /[0-9]/)" value="<?php echo $temp[1] ?>">  </div>  <div class="row">    <label for="class">      Class    </label>    <input class="text-field" id="class" name="class" style="width:450px;" value="<?php echo $class ?>">  </div>  <div class="row" >    <label for="class">      Widgets Control Panel    </label>      </div>  <div class="row" style="padding:5px;border:1px dashed #ccc;">    <?php    $widgetInfo = getWidget($widgetId);    include $_SESSION['ROOT_DIR'] . '/widgets/' . $widgetInfo['widget_type'] . '/admin.php';    ?>    <input type="hidden" id="parameters" value="<?php echo $widgetInfo['parameters']; ?>">  </div>  <div class="row" id="widgetInfo">  </div></div><?phpif ($_REQUEST['cmd'] == 'See' && $widgetId){  ?>  <div class="footer-pane">    <a href="javascript:void(0)" id="SelectBtn" class="button" style="margin-right:10px;" onclick="editPart()">      Save    </a>    <a href="javascript:void(0)" id="SelectBtn" class="button orange" style="margin-right: 5px;" onclick="deletePart()">      Remove    </a>  </div>  <?php}else{  ?>  <div class="footer-pane">    <a href="javascript:void(0)" id="SelectBtn" class="button green" onclick="addPart()">      Add    </a>  </div>  <?php}?><script  type="text/javascript">  var oldLinkRow;  var path;  function selectLinkRow(rowElm, p)  {    if (oldLinkRow)      oldLinkRow.className = "BoxRow";    rowElm.className = "BoxRow Selected";    oldLinkRow = rowElm;    path = p;  }  function addPart()  {    var wid = '';    var pid = '';    if (obj('widgetId').disabled == false)    {      wid = obj('widgetId').value;    }    if (obj('panelId').disabled == false)    {      pid = obj('panelId').value;    }    loadPage('WidgetsManagement/UIStructureParts.php', 'PartForm', 'cmd=Add&uiStructureId=<?php echo $uiStructureId ?>&widgetId=' + wid            + '&parentId=' + obj('parentId').value            + '&panelId=' + pid            + '&position=' + $("#position").val()            + '&order=' + obj('order').value);    //setVisible('TopContentPane', false);          }  function editPart()  {    var wid = '';    var pid = '';    if (obj('widgetId').disabled == false)    {      wid = obj('widgetId').value;    }    if (obj('panelId').disabled == false)    {      pid = obj('panelId').value;    }    loadPage('WidgetsManagement/UIStructureParts.php', 'PartForm', 'cmd=Edit&partId=<?php echo $partId ?>&widgetId=' + wid            + '&parentId=' + obj('parentId').value            + '&panelId=' + pid            + '&position=' + $("#position").val()            + '&order=' + obj('order').value);    //setVisible('TopContentPane', false);          }  function deletePart()  {    if (confirm("Do you really want to remove this widget?"))    {      $.post('WidgetsManagement/UIStructureParts.php', {cmd: "Delete", partId:<?php echo $widgetId ?>}, function(data) {        neuis.currentDialog.dispose();        neuis.reloadFrame();      });      //setVisible('TopContentPane', false);    }  }  function changeType()  {    if (obj('type').value === "1")    {      $('#panels').fadeIn(0);      $('#widgets').fadeOut(0);      $('#parents').fadeOut(0);    }    else if (obj('type').value === "2")    {      $('#panels').fadeOut(0);      $('#widgets').fadeIn(0);      $('#parents').fadeIn(0);    }  }  changeType();</script>