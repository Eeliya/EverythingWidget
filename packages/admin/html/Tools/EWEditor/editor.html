<!DOCTYPE html>
<html>
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
      <link rel='stylesheet' href="../../../core/css/bootstrap.css"/>
      <link rel='stylesheet' href="medium-editor.css"/>
      <link rel='stylesheet' href="default.css"/>
      <script src="../../../core/js/jquery/jquery-2.1.1.min.js"></script>        

      <script src="mjbp.js"></script>
      <style>
         html, body{padding:0px;margin:0px;height:100%;} 
         body{padding-top:30px;}
         .container{width:100%;height:100%;outline: none;}
         #container{height:auto;border:2px solid #ccc;width:100%;top:0px;bottom:10px;position:absolute;overflow:auto;}
         .column.active:hover {outline-color:#333;border-color:#333;}
         img.active,div.active,#container.active{outline-color:#333;border-color:#333;}
         div.active:before{color:#fff;background-color:#333;}
         /*div.active:hover{border-color:#333}*/
         .row{border:0px solid rgba(0,0,0,.2);border-width:2px 0;position:relative;min-height: 33px;margin-top: 6px;margin-bottom: 6px; padding-top: 2px; padding-bottom: 2px;} 
         /*.row:hover {border-color:#3cf}*/
         .column{border:0px dotted #ccc;min-height:48px;position:relative;background-color: #eee;outline-offset: -1px;outline:1px dashed #999;}
         .column:hover {outline-color:#3cf}
         .ew-block-remove {display:none;z-index:100;font-family:'FontAwesome';position:absolute;right:1px; top:1px;text-align:center;cursor:pointer;color:#F44336;background-color: rgba(255,255,255,.5);}
         .ew-block-remove i{display:block;width:20px;height:20px;font-size:15px;font-weight:normal;line-height:20px;}
         .active > .ew-block-remove{display:block;}
         .control-row{width:100%;padding:10px;background-color:rgba(255,255,255,.5);position:absolute;z-index:5;margin-top: -56px;text-align:center;position:absolute;bottom:0px;}
         .control-row .btn{float:none;margin:0px 5px;display:inline-block;}
         img{display:block;margin:0px auto;max-width:100%;border:2px solid transparent;}
         p{background-color:#eee;}
         p.active{background-color:#daeaff;}
         p:focus
         {
            outline: 1px solid #3cf;
         }
         .col-xs-12 {float:left;}
      </style>

      <script>
         $(document).ready(function () {
            //CKEDITOR.disableAutoInline = true;

            Editor =
                    {
                       activeElement: null,
                       controlRow: $("#control-row"),
                       eventHandlers: [],
                       /*textNodeHandler: function (e)
                        {
                        e.preventDefault();
                        var self = this;
                        var target = $(e.target);
                        
                        //target.focus();
                        target.addClass('active');
                        if (self.activeElement)
                        {
                        target.children(".ew-block-remove").remove();
                        self.activeElement.off('click');
                        self.activeElement.removeClass('active');
                        self.activeElement.on('click', $.proxy(self.clickHandler, self));
                        self.activeElement.attr('contenteditable', false);
                        }
                        target.attr('contenteditable', true);
                        //target.focus();
                        self.activeElement = target;
                        },*/
                       clickHandler: function (e)
                       {
                          e.preventDefault();
                          var self = this;
                          var target = $(e.target);

                          //return;
                          editor.activeComponent = target;
                          // If target is editor component, then select it else search for parent component and select it
                          if (!target.is(".e-e"))
                          {
                             target = target.closest(".e-e");
                             if (target.length === 0 && target === editor.activeComponent)
                             {
                                //console.log("ret")
                                return;
                             }
                          }

                          if (self.activeElement/* && !self.activeElement.is('#container')*/)
                          {
                             target.children(".ew-block-remove").remove();
                             //self.activeElement.off('click');
                             self.activeElement.removeClass('active');
                             //editor.activeComponent = target;
                             //self.activeElement.on('click', $.proxy(self.clickHandler, self));
                             //self.activeElement.attr('contenteditable', false);
                          }

                          //if (!target.is('#container'))
                          //target.attr('contenteditable', true);
                          if (target.is(".column"))
                          {

                             target.prepend("<div class='ew-block-remove' contenteditable='false'><i class='fa fa-times'></i></div>");
                             target.find('.ew-block-remove').on('click', function ()
                             {
                                //console.log(target.parent())
                                if (target.parent().children().length <= 1)
                                {
                                   target.parent().remove();
                                   setTimeout(function () {
                                      $("#container").click();
                                   }, 0);

                                }
                                else
                                   target.remove();

                             });

                          }
                          if (target.is('#container'))
                          {
                             //target.attr('contenteditable', true);
                             var selection = window.getSelection();
                             var range = document.createRange();
                             range.selectNode(target[0])
                             range.collapse();
                             selection.addRange(range);
                          }
                          //target.attr('contenteditable', true);
                          self.activeElement = target;
                          self.activeElement.addClass('active');
                          setTimeout(function () {
                             target.focus();
                          }, 1);



                          //var targetElement = target[0];


                          //var range = document.createRange();
                          /*if (targetElement.lastChild)
                           range.setStart(targetElement.lastChild, 0)
                           else*/

                          //range.setStart(targetElement, 0);

                          //selection.addRange(range);

                          //targetElement.focus();

                          self.triggerSelectElement();
                       },
                       addColumn: function (row, size)
                       {
                          var self = this;
                          var col = $("<div class='column e-e' contenteditable='true'>&nbsp;</div>");
                          col.addClass("col-xs-" + (size || 12));

                          //col.on('click', $.proxy(this.clickHandler, self));

                          this.addElement(col, row, true);
                          
                          setTimeout(function () {
                             editor.newParagraph(col[0]);
                             col.click();
                          }, 0);

                          return col;
                       },
                       addRow: function (col)
                       {
                          var self = this;
                          var row = $("<div class='row e-e' contenteditable='true'></div>");
                          //row.focus();
                          //row.on('click', $.proxy(this.clickHandler, self));
                          /*row.append("<div class='ew-block-remove' contenteditable='false'><i class='fa fa-times'></i></div>");
                           row.find('.ew-block-remove').on('click', function ()
                           {
                           row.remove();
                           });*/

                          this.addElement(row, col, false);
                          //setTimeout(function () {
                          self.addColumn(row, 12);
                          //}, 1)

                          //row.click();
                          return row;
                       },
                       addImage: function (parent, src)
                       {
                          var self = this;
                          var img = $("<img class='e-e'>");
                          img.attr('src', src);
                          img.css({
                             margin: '0px auto',
                             display: 'block'
                          });
                          //img.on('click', $.proxy(this.clickHandler, self));


                          this.addElement(img, parent);
                          img.click();
                          return img;
                       },
                       selectElement: function (e)
                       {

                       },
                       addTextElement: function (e, p)
                       {
                          //$(e).on('click', $.proxy(this.textNodeHandler, this));
                          this.addElement(e, p);
                          $(e).click();
                       },
                       addElement: function (e, p, focus)
                       {
                          var parent = p || $("#container");
                          parent.append(e);

                          //var ce = $("#container")[0];
                          if (focus)
                             setTimeout(function ()
                             {
                                /*if (e[0].setSelectionRange)
                                 {
                                 ce.focus();
                                 ce.setSelectionRange(0, 0);
                                 }
                                 else
                                 {*/
                                var selection = window.getSelection();
                                var range = document.createRange();
                                //range.selectNodeContents(e[0]);
                                range.setStart(e[0], 0);
                                range.selectNode(e[0]);
                                //range.setEnd(e[0], 0);
                                //range.setStart(e[0],0);
                                selection.removeAllRanges();
                                //range.selectNode(e[0]);
                                selection.addRange(range);

                                //}
                                $("#container").focus();
                                e[0].innerHTML = '';
                             }, 1);
                          return e;
                       },
                       triggerSelectElement: function (content)
                       {
                          $(document.body).trigger('element-select', [this.activeElement]);

                          for (var i = 0; i < this.eventHandlers.length; i++)
                          {
                             this.eventHandlers[i].action.call(this, this.activeElement);
                          }
                       },
                       on: function (name, action)
                       {
                          this.eventHandlers.push({
                             name: name,
                             action: action
                          });
                       },
                       init: function ()
                       {
                          var self = this;
                          var container = $("#container");
                          //var ce = $("#container")[0];
                          container.on('click', $.proxy(this.clickHandler, self));
                          container.on('dblclick', function (e) {
                             if (e.target === container[0])
                             {
                                e.preventDefault();
                                editor.newParagraph();
                             }
                          });
                          container.click();
                       }
                    };

            var editor = new MJEditor(document.getElementById("container"), {
               buttons: ['b', 'i', 'blockquote', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ol', 'ul', 'a', 'cancel', 'back', 'enter']
            });
            editor.activeComponent = $("#container");
         });
         //console.log($(document));
      </script>
   </head>
   <body>
      <div id="editor">
         <div id="editor-mask">
            <div class="editor-buttons">
               <button id="editor-b" data-command="bold"><i class="fa fa-bold"></i></button>
               <button id="editor-i" data-command="italic"><i class="fa fa-italic"></i></button>
               <button id="editor-blockquote" data-command="quote"><i class="fa fa-quote-left"></i></button>
               <button id="editor-left" data-command="left"><i class="fa fa-align-left"></i></button>
               <button id="editor-center" data-command="center"><i class="fa fa-align-center"></i></button>
               <button id="editor-right" data-command="right"><i class="fa fa-align-right"></i></button>
               <button id="editor-justify" data-command="justify"><i class="fa fa-align-justify"></i></button>
               <button class="heading" id="editor-h1" data-command="h1"><i class="fa fa-header"></i>1</button>
               <button class="heading" id="editor-h2" data-command="h2"><i class="fa fa-header"></i>2</button>
               <button class="heading" id="editor-h3" data-command="h3"><i class="fa fa-header"></i>3</button>
               <button class="heading" id="editor-h4" data-command="h4"><i class="fa fa-header"></i>4</button>
               <button class="heading" id="editor-h5" data-command="h5"><i class="fa fa-header"></i>5</button>
               <button class="heading" id="editor-h6" data-command="h6"><i class="fa fa-header"></i>6</button>
               <button id="editor-ol" data-command="ol"><i class="fa fa-list-ol"></i></button>
               <button id="editor-ul" data-command="ul"><i class="fa fa-list-ul"></i></button>
               <button id="editor-a" data-command="a"><i class="fa fa-link"></i></button>

            </div>
            <div id="editor-link-field-holder">
               <input type="text" id="editor-link-field" placeholder="Type or paste link">
               <button id="editor-cancel" data-command="cancel"><i class="fa fa-unlink"></i></button>
               <button id="editor-back" data-command="back"><i class="fa fa-arrow-left"></i></button>
               <button class="pull-right" id="editor-enter" data-command="enter"><i class="fa fa-check"></i></button>
            </div>
         </div>
      </div>
      <div id='container' class='container e-e' contenteditable="true">
      </div>
   </body>
</html>
