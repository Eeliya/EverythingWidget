<?phpsession_start();include($_SESSION['ROOT_DIR'] . '/config.php');if (!$_SESSION['login']){    include($_SESSION['ROOT_DIR'] . '/admin/LoginForm.php');    return;}$widgetId = mysql_real_escape_string($_POST['widgetId']);$widgetTypeId = mysql_real_escape_string($_POST['widgetTypeId']);$name = mysql_real_escape_string($_POST['name']);$rootDir = mysql_real_escape_string($_POST['rootDir']);$description = mysql_real_escape_string($_POST['description']);$styleId = mysql_real_escape_string($_POST['styleId']);$class = mysql_real_escape_string($_POST['class']);$style = mysql_real_escape_string($_POST['style']);if ($_REQUEST['cmd'] == 'Add' && trim($name)){    $result = mysql_query("INSERT INTO widget_types             (name , root_dir , description , style_id , class , style)             VALUES ('$name' , '$rootDir' , '$description' , '$styleId' , '$class' , '$style')");    if ($result)    {        ?>        <span class="Title" style="color: #339900;" >            نوع ویجت جدید با موفقیت ثبت شد        </span>        <script  type="text/javascript">                listWidgetsTypes();        </script>        <?php        return;    }    else    {        ?>        <span class="Title" style="color: #dd2200;" >            خطا: نوع ویجت جدید ثبت نشد        </span>        <?php        return;    }}else if ($_REQUEST['cmd'] == 'Edit' && trim($name)){    $result = mysql_query("UPDATE widget_types SET name = '$name'             , root_dir = '$rootDir'            , description = '$description'            , style_id = '$styleId'            , class = '$class'             , style = '$style' WHERE id = '$widgetTypeId'");    if ($result)    {        ?>        <span class="Title" style="color: #339900;" >            نوع ویجت با موفقیت ویرایش شد        </span>        <span class="BackButton" onclick="seeWidgetTypeInfo()"></span>        <script  type="text/javascript">                listWidgetsTypes();        </script>        <?php        return;    }    else    {        ?>        <span class="Title" style="color: #dd2200;" >            خطا: نوع ویجت ویرایش نشد        </span>        <?php        return;    }}else if ($_REQUEST['cmd'] == 'Delete' && $widgetTypeId){    $result = mysql_query("DELETE FROM widget_types WHERE id = '$widgetTypeId'");    if ($result)    {        ?>        <span class="Title" style="color: #339900;" >            نوع ویجت با موفقیت حذف شد        </span>        <script  type="text/javascript">                listWidgetsTypes();        </script>        <?php        return;    }    else    {        ?>        <span class="Title" style="color: #dd2200;" >            خطا:نوع ویجت حذف نشد        </span>        <?php        return;    }}else if ($_REQUEST['cmd'] == 'See'){    $result = mysql_query("SELECT * FROM widget_types WHERE id = '$widgetTypeId'") or die(mysql_error());    while ($row = mysql_fetch_array($result))    {        $name = $row['name'];        $rootDir = $row['root_dir'];        $description = $row['description'];        $styleId = $row['style_id'];        $class = $row['class'];        $style = $row['style'];        ?>        <span class="Title">            ویرایش  نوع ویجت: <?php echo $name ?>        </span>        <span style="width: 100%; float: right;" id="FormContent">            <?php        }    }    else    {        ?>        <span class="Title">            نوع ویجت جدید        </span>        <span style="width: 100%; float: right;" id="FormContent">            <?php        }        if ($_REQUEST['cmd'] == 'See')        {            ?>            <form action="#" method="POST" onsubmit="return editWidgetType()">                <?php            }            else            {                ?>                <form action="#" method="POST" onsubmit="return addWidgetType()">                    <?php                }                ?>                <span class="row">                    <span class="Label" style="width: 200px; text-align: left; direction: ltr;">                        Name                    </span>                </span>                <span class="row">                    <input class="text-field" value="<?php echo $name ?>" id="name" style="width: 200px; direction: ltr;" >                                    </span>                               <span class="row">                    <span class="Label" style="width: 200px; text-align: left; direction: ltr;">                        Root Directory                    </span>                </span>                <span class="row">                    <input class="text-field" value="<?php echo $rootDir ?>" id="rootDir" style="width: 200px; direction: ltr;" >                </span>                <span class="row">                    <span class="Label" style="width: 200px; text-align: right;">                        توضیح                    </span>                </span>                <span class="row">                    <textarea class="text-field" id="description"                              style="width: 414px;                               max-width: 414px;                               min-width: 414px;                               min-height: 80px;                               direction: ltr;"  ><?php echo $description ?></textarea>                </span>                <span class="row">                                  <span class="Label" style="width: 414px; text-align: left; direction: ltr;">                        class                    </span>                </span>                <span class="row">                    <input class="text-field" value="<?php echo $class ?>" id="class" style="width: 414px; direction: ltr;" onkeyup="setView()">                </span>                <span class="row">                    <span id="classValue" class="SmallLabel" style="width: 414px; direction: ltr; text-align: left;">                        <?php echo $class ?>                    </span>                </span>                <span class="row">                    <span class="Label" style="width: 414px; text-align: left; direction: ltr;" >                        style                    </span>                </span>                <span class="row">                    <textarea class="text-field" id="style"                              style="width: 414px;                               max-width: 414px;                               min-width: 414px;                               min-height: 120px;                               direction: ltr;" onkeydown="ifShift(event)" onkeyup="setView() & nextLine(event)" ><?php echo $style ?></textarea>                </span>                <span class="row">                    <span class="Label">                        پیش نمایش                    </span>                </span>                <iframe class="row"                         id="fr"                         style="width:100%; border: none;                         margin: 0px; overflow: scroll; height: 300px; direction: ltr; background-image: url('styles/EditorBG.png')"                                                 src="WidgetsManagement/Editor.php?widgetTypeId=<?php echo $widgetTypeId ?>">                </iframe>                <input type="submit" style="display: none;" value="ثبت">                <?php                if ($_REQUEST['cmd'] == 'See')                {                    ?>                    <span class="button green" style="float: left; margin: 10px;" title="ذخیره" onclick="editWidgetType()" >                        ذخیره                    </span>                    <span class="button Red"  onclick="deleteWidgetType()" >                        حذف                    </span>                    <?php                }                else                {                    ?>                    <span class="button green" style="float: left; margin: 10px;" title="ثبت" onclick="addWidgetType()" >                        ثبت                    </span>                    <?php                }                ?>            </form>                        <?php            if (!$_REQUEST['cmd'])            {                ?>        </span>        <?php    }    ?>    <script  type="text/javascript">        function addWidgetType()        {            if(!obj('name').value)            {                obj('name').className = 'TextField Red';                return;            }            obj('name').className = 'TextField';            loadPage('WidgetsManagement/NEWidgetTypeForm.php', 'FormContent', 'cmd=Add&name='+obj('name').value                +'&rootDir='+obj('rootDir').value                +'&description='+obj('description').value                +'&class='+obj('class').value                +'&style='+obj('style').value );            return false;        }                          function editWidgetType()        {            if(!obj('name').value)            {                obj('name').className = 'TextField Red';                return;            }            obj('name').className = 'TextField';            loadPage('WidgetsManagement/NEWidgetTypeForm.php', 'FormContent', 'cmd=Edit&widgetTypeId=<?php echo $widgetTypeId ?>&&name='+obj('name').value                +'&rootDir='+obj('rootDir').value                +'&description='+obj('description').value                +'&class='+obj('class').value                +'&style='+obj('style').value );            return false;        }                 function setView()        {               if(obj('fr').contentDocument.getElementById('dynamicStyle'))            {                obj('fr').contentDocument.getElementById('dynamicStyle').innerHTML = obj('style').value;                obj('fr').contentDocument.getElementById('<?php echo $name ?>').className = 'Widget <?php echo $class ?> '+obj('class').value;            }            obj('classValue').innerHTML = 'Widget '+obj('class').value;                    }                var sh = false;        function ifShift(evt)        {            var theEvent = evt || window.event;            sh = theEvent.shiftKey;        }                       function nextLine(evt)        {            var theEvent = evt || window.event;            var keycode = (theEvent.keyCode ? theEvent.keyCode : theEvent.which);                        if((keycode == 59 || keycode == 186) && !sh)            {                var car = getCaret(obj('style'))+1;                                obj('style').value = obj('style').value+'\n';                obj('style').setSelectionRange(car ,car);            }                if((keycode == 59 || keycode == 186) && sh)            {                var car = getCaret(obj('style'))+1;                        obj('style').value = obj('style').value + ' ';            }                    }        setView();    </script>